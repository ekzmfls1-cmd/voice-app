<!DOCTYPE html>
<html lang="ko" data-bs-theme="dark">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ì›¹ ì „ìš© ë‚˜ë ˆì´ì…˜ ì‹œìŠ¤í…œ V23.1.9 (ì¼ê´„ ë³€ê²½ ê¸°ëŠ¥ ì‚­ì œ, 0ms ìœ ì§€)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ */
        .voice-select { min-width: 220px; }
        .input-group-text { width: 90px; }
        .slider-label { font-size: 12px; display: flex; justify-content: space-between; align-items: center;}
        .note-small { font-size: 12px; color: #9aa0a6; }
        
        /* ìºë¦­í„° ì¹´ë“œ ìŠ¤íƒ€ì¼ (ìƒ‰ìƒ ì½”ë”© ìœ ì§€) */
        .character-card { margin-bottom: 15px; border-left: 6px solid #0d6efd; }
        .char-color-0.character-card { border-left-color: #0d6efd !important; } 
        .char-color-1.character-card { border-left-color: #20c997 !important; }
        .char-color-2.character-card { border-left-color: #ffc107 !important; }

        /* ëŒ€ë³¸ ì—ë””í„° ìŠ¤íƒ€ì¼ */
        #script-editor {
            border: 1px solid #495057; 
            min-height: 200px;
            overflow-y: auto;
            border-radius: 0.375rem;
            background-color: #212529; 
            color: #f8f9fa; 
            padding: 1rem;
            cursor: default; 
        }

        /* ì ê¸ˆ í•´ì œ ìƒíƒœì˜ ì»¤ì„œ */
        #script-editor[contenteditable="true"] {
             cursor: text;
        }
        
        /* ë¬¸ì¥ë³„ ë‹¨ë½ ìŠ¤íƒ€ì¼ */
        #script-editor p {
            margin: 0;
            padding: 2px 0;
            line-height: 1.6;
            border-left: 3px solid transparent;
            padding-left: 8px;
            transition: border-left 0.2s;
        }

        /* ë¬¸ì¥ë³„ ìºë¦­í„° ìƒ‰ìƒ í‘œì‹œ */
        .char-color-0 { border-left-color: #0d6efd !important; }
        .char-color-1 { border-left-color: #20c997 !important; }
        .char-color-2 { border-left-color: #ffc107 !important; }

        /* ì‹¤ì‹œê°„ ë‹¨ì–´ í•˜ì´ë¼ì´íŠ¸ ìŠ¤íƒ€ì¼ */
        .highlight {
            background-color: rgba(255, 255, 0, 0.4); 
            color: #000; 
            border-radius: 3px;
            padding: 2px 3px;
            display: inline;
        }
        
        /* í˜„ì¬ ë¬¸ì¥ ë°°ê²½ ê°•ì¡° ìŠ¤íƒ€ì¼ */
        .current-line {
            background-color: rgba(13, 110, 253, 0.2);
            border-radius: 5px;
            margin: 5px -5px; 
            padding-left: 10px !important; 
        }

        /* ë²„íŠ¼ ìƒíƒœ ì‹œê°í™”ë¥¼ ìœ„í•œ ìŠ¤íƒ€ì¼ */
        #play-btn.playing { background-color: #007bff; border-color: #007bff; }
        #pause-btn.playing { background-color: #ffc107; border-color: #ffc107; }
        #stop-btn.playing { opacity: 0.7; }
        
        /* ğŸ’¡ ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        .sidebar {
            padding: 1rem;
            border-radius: 0.5rem;
            height: 100%;
            background-color: #2b3035; /* Darker background for distinction */
            color: #f8f9fa;
        }
        .sidebar h5 {
            border-bottom: 1px solid #495057;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }
        .sidebar ul {
            list-style: none;
            padding-left: 0;
        }
        .sidebar li {
            margin-bottom: 0.75rem;
            font-size: 0.95rem;
        }
    </style>
</head>
<body>
<div class="container-fluid py-5">
    <div class="row">
        
        <div class="col-md-3 d-none d-lg-block">
            <div class="sidebar">
                <h5 class="text-primary"><i class="bi bi-list-ol"></i> ì‚¬ìš© ë°©ë²•</h5>
                <ul>
                    <li>**1ë‹¨ê³„: ëŒ€ë³¸ ì…ë ¥**
                        <ul>
                            <li>- ê° ë¬¸ì¥ì„ ì—”í„°(Enter)ë¡œ êµ¬ë¶„í•©ë‹ˆë‹¤.</li>
                            <li>- ìºë¦­í„°ëŠ” `ìºë¦­í„°ì´ë¦„: ëŒ€ì‚¬` í˜•ì‹ìœ¼ë¡œ ì”ë‹ˆë‹¤. (ì˜ˆ: `ì² ìˆ˜: ì•ˆë…•`)</li>
                            <li>- ê´„í˜¸ `(ê°ì •)`ì€ ëŒ€ì‚¬ì—ì„œ ìë™ìœ¼ë¡œ ì œê±°ë©ë‹ˆë‹¤.</li>
                        </ul>
                    </li>
                    <li>**2ë‹¨ê³„: ëŒ€ë³¸ ë¶„ì„**
                        <ul>
                            <li>- ëŒ€ë³¸ ìˆ˜ì •ì„ ë§ˆì¹œ í›„, **'ëŒ€ë³¸ ë¶„ì„'** ë²„íŠ¼ì„ ëˆ„ë¦…ë‹ˆë‹¤.</li>
                            <li>- ë¬¸ì¥ì„ ë¶„ì„í•˜ê³  ìºë¦­í„°ë¥¼ ìë™ ë¶„ë¥˜í•©ë‹ˆë‹¤.</li>
                        </ul>
                    </li>
                    <li>**3ë‹¨ê³„: ëª©ì†Œë¦¬ ì„¤ì •**
                        <ul>
                            <li>- ê° ìºë¦­í„°ë³„ë¡œ ì›í•˜ëŠ” ëª©ì†Œë¦¬, ì†ë„, ë†’ë‚®ì´ ë“±ì„ ì¡°ì ˆí•©ë‹ˆë‹¤.</li>
                            <li>- **'ë¯¸ë¦¬ë“£ê¸°'**ë¡œ í™•ì¸í•˜ì„¸ìš”.</li>
                        </ul>
                    </li>
                    <li>**4ë‹¨ê³„: ì¬ìƒ ì œì–´**
                        <ul>
                            <li>- **'ì¬ìƒ (ì²˜ìŒë¶€í„°)'** ë˜ëŠ” ëŒ€ë³¸ì„ í´ë¦­í•˜ì—¬ ì»¤ì„œë¥¼ ë†“ì€ ë’¤ **'ì¬ìƒ (ì„ íƒ ìœ„ì¹˜ë¶€í„°)'**ë¥¼ ëˆ„ë¦…ë‹ˆë‹¤.</li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
        
        <div class="col-lg-6 col-md-12">
            <div class="text-center mb-4">
                <h1 class="display-5">ğŸ™ï¸ ì›¹ ì „ìš© ë‚˜ë ˆì´ì…˜ ì‹œìŠ¤í…œ V23.1.9</h1>
                <p class="lead text-secondary">ì¼ê´„ ë³€ê²½ ê¸°ëŠ¥ì´ ì‚­ì œë˜ê³ , **0ms (ì‰¼ ì—†ìŒ)** ìµœëŒ€ ì†ë„ë§Œ ìœ ì§€ë©ë‹ˆë‹¤.</p>
            </div>

            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">1. ëŒ€ë³¸ ì¤€ë¹„</h5>
                    
                    <div id="script-editor" rows="8"> 
                        <p>í•´ì„¤: ì˜¤ëŠ˜ ì•„ì¹¨ì€ ìœ ë‚œíˆ ë§‘ì•˜ìŠµë‹ˆë‹¤.</p>
                        <p>ì² ìˆ˜: ì™€, ë‚ ì”¨ê°€ ì •ë§ ì¢‹ë„¤ìš”!</p>
                        <p>ì˜í¬: ë¹¨ë¦¬ í”¼í¬ë‹‰ ê°€ê³  ì‹¶ì–´ìš”. (ì‹ ë‚˜ê²Œ)</p>
                        <p>í•´ì„¤: ê·¸ë“¤ì€ í–‰ë³µí•œ í•˜ë£¨ë¥¼ ë³´ëƒˆìŠµë‹ˆë‹¤.</p>
                        <p></p>
                        <p>ì² ìˆ˜: ë‹¤ì‹œ í•´ì„¤í•´ë³´ì‹œì£ .</p>
                    </div>
                    
                    <div class="d-flex gap-2 mt-2">
                        <button id="analyze-btn" class="btn btn-primary w-50">ëŒ€ë³¸ ë¶„ì„ ë° ìºë¦­í„° ì„¤ì • ì‹œì‘</button>
                        <button id="edit-mode-btn" class="btn btn-outline-warning w-50" style="display:none;">ğŸ”“ ëŒ€ë³¸ ìˆ˜ì •</button> 
                    </div>
                    <button id="start-play-btn" class="btn btn-success w-100 mt-2">â–¶ ì¬ìƒ (ì„ íƒ ìœ„ì¹˜ë¶€í„°)</button> 
                    
                    <div class="d-flex gap-2 mt-2">
                        <input type="file" id="load-file" class="form-control d-none" accept=".json">
                        <button id="load-btn" class="btn btn-outline-info w-50">ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                        <button id="export-btn" class="btn btn-outline-success w-50">ğŸ’¾ ë‚´ë³´ë‚´ê¸°</button>
                    </div>
                    <p class="note-small mt-2">ì°¸ê³ : ê´„í˜¸() ì•ˆì˜ ê°ì • ì§€ì‹œë¬¸ì€ ì½ì§€ ì•ŠìŠµë‹ˆë‹¤. **ëŒ€ë³¸ì˜ ê° ë¬¸ì¥ì„ ì—”í„°ë¡œ êµ¬ë¶„**í•´ì£¼ì„¸ìš”.</p>
                </div>
            </div>

            <div id="character-settings" class="card mb-4" style="display:none;">
                <div class="card-body">
                    <h5 class="card-title">2. ìºë¦­í„°ë³„ ëª©ì†Œë¦¬ ì„¤ì • (í•œêµ­ì–´ ìŒì„±ë§Œ í‘œì‹œ)</h5>
                    <div id="voice-warning" class="alert alert-warning" style="display:none;">
                        âš ï¸ í˜„ì¬ ë¸Œë¼ìš°ì €/OSì— í•œêµ­ì–´ ìŒì„±ì´ ì—†ìŠµë‹ˆë‹¤. (í•œêµ­ì–´ ìŒì„±ì„ ì„¤ì¹˜í•˜ê±°ë‚˜, ë‹¤ë¥¸ ì¥ì¹˜/ë¸Œë¼ìš°ì €ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.)
                    </div>
                    <div id="character-list"></div>
                </div>
            </div>

            <div id="player" class="card" style="display:none;">
                <div class="card-body">
                    <h5 class="card-title">3. ì „ì²´ ì¬ìƒ ì œì–´</h5>
                    
                    <label for="global-rate" class="slider-label">
                        ì „ì²´ ì¬ìƒ ì†ë„ (Global Rate) 
                        <span id="global-rate-value" class="badge text-bg-secondary">1.00</span>
                    </label>
                    <input type="range" id="global-rate" min="0.1" max="4" step="0.01" value="1" class="form-range mb-3">
                    
                    <label for="sentence-pause-ms" class="slider-label">
                        ë¬¸ì¥ ê°„ ê¸°ë³¸ ì§€ì—° ì‹œê°„ (ms) 
                        <span id="sentence-pause-ms-value" class="badge text-bg-secondary">0</span>
                    </label>
                    <input type="range" id="sentence-pause-ms" min="0" max="3000" step="50" value="0" class="form-range mb-3">

                    <div class="d-flex gap-2">
                        <button id="play-btn" class="btn btn-success w-50">â–¶ ì¬ìƒ (ì²˜ìŒë¶€í„°)</button>
                        <button id="pause-btn" class="btn btn-warning w-25">â¸ ì¼ì‹œì •ì§€</button>
                        <button id="stop-btn" class="btn btn-danger w-25">â¹ ì •ì§€</button>
                    </div>
                    <div id="status-area" class="alert alert-secondary mt-3">
                        <strong>ìƒíƒœ:</strong> <span id="status-text">ëŒ€ê¸° ì¤‘</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3 d-none d-lg-block">
            <div class="sidebar">
                <h5 class="text-success"><i class="bi bi-lightbulb-fill"></i> í•µì‹¬ íŒ & ì°¸ê³  ì‚¬í•­</h5>
                <ul>
                    <li>**ìŠ¤í¬ë¡¤ ê³ ì • ê¸°ëŠ¥**
                        <ul>
                            <li>- **ì¬ìƒ ì¤‘ì—ë„ ìŠ¤í¬ë¡¤ì´ ìë™ìœ¼ë¡œ ì›€ì§ì´ì§€ ì•ŠìŠµë‹ˆë‹¤.** ì‚¬ìš©ìê°€ ì›í•˜ëŠ” ëŒ€ë³¸ ìœ„ì¹˜ë¥¼ ì§ì ‘ ë³´ë©´ì„œ ì‘ì—…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
                        </ul>
                    </li>
                    <li>**ê°ì • ì—°ì¶œ**
                        <ul>
                            <li>- **'ìŠ¬í””'** : **ì†ë„/ë†’ë‚®ì´/ë³¼ë¥¨**ì„ ëª¨ë‘ ë‚®ì¶¥ë‹ˆë‹¤.</li>
                            <li>- **'ê¸°ì¨'** : **ì†ë„/ë†’ë‚®ì´**ë¥¼ ë†’ê²Œ ì„¤ì •í•©ë‹ˆë‹¤.</li>
                        </ul>
                    </li>
                    <li>**ì„¸ë¶€ ì¡°ì •**
                        <ul>
                            <li>- ë¬¸ì¥ ì‚¬ì´ì˜ **ì§€ì—° ì‹œê°„(ms)**ì„ ì¡°ì ˆí•˜ì—¬ í˜¸í¡ì„ ì—°ì¶œí•©ë‹ˆë‹¤. (**0msë¡œ ë‹¨ì¶•ë¨**)</li>
                            <li>- **ê¸€ë¡œë²Œ ì†ë„**ë¡œ ì „ì²´ ì¬ìƒ ì†ë„ë¥¼ ì¼ê´„ ë³€ê²½í•©ë‹ˆë‹¤.</li>
                        </ul>
                    </li>
                    <li>**ë¬¸ì œ ë°œìƒ ì‹œ**
                        <ul>
                            <li>- ì†Œë¦¬ê°€ ë‚˜ì§€ ì•Šì„ ê²½ìš°, **ë¸Œë¼ìš°ì €ë¥¼ ì¬ì‹œì‘**í•˜ê±°ë‚˜ **ë‹¤ë¥¸ ë¸Œë¼ìš°ì €(í¬ë¡¬, ì—£ì§€ ë“±)**ë¡œ ì‹œë„í•´ ë³´ì„¸ìš”.</li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
    // Web Speech API ê¸°ë°˜ ë‚˜ë ˆì´ì…˜ ì‹œìŠ¤í…œ V23.1.9 (ì¼ê´„ ë³€ê²½ ê¸°ëŠ¥ ì‚­ì œ)
    const synth = window.speechSynthesis;
    let availableVoices = [];
    let analyzedLines = []; 
    let lastAnalyzedText = ''; 
    let isStopping = false; 
    let currentPlaybackIndex = 0; // ë‹¤ìŒì— ì¬ìƒí•  ë¬¸ì¥ì˜ ì¸ë±ìŠ¤

    // DOM ìš”ì†Œ
    const scriptEditor = document.getElementById('script-editor');
    const analyzeBtn = document.getElementById('analyze-btn');
    const startPlayBtn = document.getElementById('start-play-btn'); 
    const characterSettingsDiv = document.getElementById('character-settings');
    const characterListDiv = document.getElementById('character-list');
    const playerDiv = document.getElementById('player');
    const playBtn = document.getElementById('play-btn');
    const pauseBtn = document.getElementById('pause-btn');
    const stopBtn = document.getElementById('stop-btn');
    const statusText = document.getElementById('status-text');
    const voiceWarning = document.getElementById('voice-warning');
    const loadBtn = document.getElementById('load-btn');
    const loadFile = document.getElementById('load-file');
    const exportBtn = document.getElementById('export-btn');
    const globalRateSlider = document.getElementById('global-rate');
    const globalRateValueSpan = document.getElementById('global-rate-value');
    const sentencePauseMsSlider = document.getElementById('sentence-pause-ms'); 
    const sentencePauseMsValueSpan = document.getElementById('sentence-pause-ms-value');
    const editModeBtn = document.getElementById('edit-mode-btn');

    // ëŒ€ë³¸ ì ê¸ˆ ìƒíƒœ
    let isScriptLocked = false; 

    function initialize() {
        loadVoices();
        synth.onvoiceschanged = loadVoices;
        analyzeBtn.addEventListener('click', analyzeScript);
        
        // ì´ˆê¸° ìƒíƒœ: í¸ì§‘ ê°€ëŠ¥
        scriptEditor.contentEditable = 'true';
        editModeBtn.style.display = 'none'; 
        editModeBtn.addEventListener('click', unlockScript);
        
        // ì¬ìƒ (ì„ íƒ ìœ„ì¹˜ë¶€í„°) ë²„íŠ¼
        startPlayBtn.addEventListener('click', () => {
            const selection = window.getSelection();
            let startCharIndex = 0;
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                const startNode = range.startContainer;
                const pElement = startNode.closest('p');
                
                let pIndex = -1;
                if (pElement) {
                    pIndex = Array.from(scriptEditor.querySelectorAll('p')).findIndex(p => p === pElement);
                    startCharIndex = range.startOffset; 
                }
                
                if (pIndex !== -1) {
                    let runningCharCount = 0;
                    for(let i = 0; i < pIndex; i++) {
                        // ê° ë¬¸ë‹¨ ëì— ì¤„ë°”ê¿ˆ ë¬¸ì 1ê°œë¥¼ ê°€ì • (+1)
                        runningCharCount += scriptEditor.querySelectorAll('p')[i].innerText.length + 1; 
                    }
                    startCharIndex = runningCharCount + startCharIndex; 
                }
            }

            let startIndex = analyzedLines.findIndex(line => 
                line.startIndex <= startCharIndex && line.endIndex >= startCharIndex
            );
            
            if (startIndex === -1 || analyzedLines[startIndex].text.length === 0) startIndex = 0; 
            
            currentPlaybackIndex = startIndex; 
            playNarration(); 
        });

        // ğŸ’¡ [í•µì‹¬] Play ë²„íŠ¼ ë¡œì§ (ì¬ìƒ/ì¼ì‹œì •ì§€/ì¬ê°œ-ì¬ì‹œì‘)
        playBtn.addEventListener('click', () => {
             if (scriptEditor.innerText.trim() !== lastAnalyzedText.trim()) {
                statusText.innerHTML = 'âŒ ì¬ìƒ ì‹¤íŒ¨: ëŒ€ë³¸ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤. **"ëŒ€ë³¸ ë¶„ì„"**ì„ ë¨¼ì € ëˆŒëŸ¬ì£¼ì„¸ìš”.';
                return;
            }
            
            if (synth.speaking && !synth.paused) {
                // Click 2: ì¬ìƒ ì¤‘ì¼ ë•Œ -> ì¼ì‹œì •ì§€ (Pause)
                synth.pause();
                statusText.textContent = 'ì¼ì‹œì •ì§€ë¨. ì´ì–´ì„œ ì¬ìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.'; 
                updatePlayerControls();
                
            } else if (synth.paused) {
                // Click 3: ì¼ì‹œì •ì§€ ì¤‘ì¼ ë•Œ -> ì¬ê°œ (Resume)
                // ë¶ˆì•ˆì •í•œ synth.resume() ëŒ€ì‹ , í˜„ì¬ ë¬¸ì¥ì„ ì·¨ì†Œí•˜ê³  ë‹¤ì‹œ ì¬ìƒ ì‹œì‘
                synth.cancel(); 
                isStopping = false; 

                playNarration(); 

                statusText.textContent = 'ì¬ìƒ ì¬ê°œ (í˜„ì¬ ë¬¸ì¥ ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œì‘)'; 
                updatePlayerControls();
                
            } else {
                // Click 1 ë˜ëŠ” ì •ì§€ ìƒíƒœ: ì¬ìƒ ì¤‘ì´ ì•„ë‹ ë•Œ (ì²˜ìŒë¶€í„° ì¬ìƒ)
                currentPlaybackIndex = 0; 
                playNarration(); 
            }
        });
        
        // Pause ë²„íŠ¼ì€ Play ë²„íŠ¼ì´ Pause ê¸°ëŠ¥ì„ ê²¸í•˜ë¯€ë¡œ, ìƒíƒœê°€ Speakingì¼ ë•ŒëŠ” Disabledë¨.
        pauseBtn.addEventListener('click', () => {
            if(synth.speaking && !synth.paused) {
                synth.pause();
                statusText.textContent = 'ì¼ì‹œì •ì§€ë¨. ì´ì–´ì„œ ì¬ìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.'; 
            }
        });
        
        // ì •ì§€ ë²„íŠ¼ ë¡œì§
        stopBtn.addEventListener('click', () => {
            synth.cancel(); 
            isStopping = true; 
            
            removeHighlight(); 
            removeCurrentLineClass();
            
            currentPlaybackIndex = 0; 
            statusText.textContent = 'ì¬ìƒì´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. (ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œì‘)';
            updatePlayerControls(); 
            checkScriptModification(); 
        });

        // ìŠ¤í˜ì´ìŠ¤ë°” ì¬ìƒ/ì¼ì‹œì •ì§€ ê¸°ëŠ¥ 
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' || e.keyCode === 32) {
                // ì…ë ¥ í•„ë“œì—ì„œëŠ” ê¸°ë³¸ ë™ì‘ ìœ ì§€
                if (e.target.nodeName === 'INPUT' || e.target.nodeName === 'TEXTAREA' || (e.target.isContentEditable && e.target.isContentEditable === 'true')) {
                    return; 
                }
                
                e.preventDefault(); 
                
                if (synth.speaking) {
                    if (synth.paused) {
                        // ì¼ì‹œì •ì§€ ìƒíƒœë©´ -> ì¬ê°œ (Web API resume ì‚¬ìš©)
                        synth.resume();
                        isStopping = false; 
                        statusText.textContent = 'ì¬ìƒ ì¬ê°œ'; 
                    } else {
                        // ì¬ìƒ ì¤‘ì´ë©´ -> ì¼ì‹œì •ì§€
                        synth.pause();
                        statusText.textContent = 'ì¼ì‹œì •ì§€ë¨. ì´ì–´ì„œ ì¬ìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.'; 
                    }
                } else if (analyzedLines.length > 0 && lastAnalyzedText.trim() === scriptEditor.innerText.trim()) {
                    // ì¬ìƒ ì¤‘ì´ ì•„ë‹ ë•Œ (ì •ì§€ ìƒíƒœê±°ë‚˜ ì§€ì—° ì‹œê°„ ì¤‘ì¼ ë•Œ) -> í˜„ì¬ ì¸ë±ìŠ¤ë¶€í„° ì¬ìƒ ì‹œì‘
                    isStopping = false; 
                    playNarration(); 
                } else {
                    // ë¶„ì„ì´ ì•ˆ ë˜ì—ˆê±°ë‚˜ ëŒ€ë³¸ì´ ìˆ˜ì •ëœ ìƒíƒœë©´ ì•ˆë‚´
                     if (lastAnalyzedText.trim() !== scriptEditor.innerText.trim()) {
                         statusText.innerHTML = 'âŒ ì¬ìƒ ì‹¤íŒ¨: ëŒ€ë³¸ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤. **"ëŒ€ë³¸ ë¶„ì„"**ì„ ë¨¼ì € ëˆŒëŸ¬ì£¼ì„¸ìš”.';
                     } else if (analyzedLines.length === 0) {
                         statusText.textContent = 'ëŒ€ë³¸ ë¶„ì„ì´ í•„ìš”í•©ë‹ˆë‹¤.';
                     }
                }
                updatePlayerControls();
            }
        });

        loadBtn.addEventListener('click', () => loadFile.click());
        loadFile.addEventListener('change', loadSettingsFromFile);
        exportBtn.addEventListener('click', exportSettingsToFile);
        
        attachSingleSliderHandler(globalRateSlider, globalRateValueSpan);
        attachSingleSliderHandler(sentencePauseMsSlider, sentencePauseMsValueSpan);

        scriptEditor.addEventListener('input', checkScriptModification);

        setInterval(updatePlayerControls, 100); 
        synth.onresume = updatePlayerControls;
        synth.onpause = updatePlayerControls;
        
        // ì´ˆê¸° ë¶„ì„ (ì´ˆê¸° ëŒ€ë³¸ìœ¼ë¡œ)
        analyzeScript();
    }
    
    function unlockScript() {
        if (isScriptLocked) {
            synth.cancel(); 
            isScriptLocked = false;
            scriptEditor.contentEditable = 'true';
            editModeBtn.style.display = 'none';
            analyzeBtn.classList.remove('disabled');
            
            lastAnalyzedText = ''; 
            checkScriptModification(); 
            
            statusText.textContent = 'ëŒ€ë³¸ í¸ì§‘ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤. ììœ ë¡­ê²Œ ìˆ˜ì • í›„ "ëŒ€ë³¸ ë¶„ì„"ì„ ë‹¤ì‹œ ëˆŒëŸ¬ì£¼ì„¸ìš”.';
        }
    }


    function checkScriptModification() {
        if (!synth.speaking && !isScriptLocked) {
            const currentText = scriptEditor.innerText.trim();
            if (currentText !== lastAnalyzedText.trim() && lastAnalyzedText !== '') {
                 statusText.innerHTML = 'âš ï¸ ëŒ€ë³¸ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤. **ì¬ìƒ ì „ "ëŒ€ë³¸ ë¶„ì„"** ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.';
                 analyzeBtn.classList.remove('btn-primary');
                 analyzeBtn.classList.add('btn-danger');
            } else if (currentText === lastAnalyzedText.trim() && analyzedLines.length > 0) {
                 statusText.textContent = 'ëŒ€ë³¸ ë¶„ì„ ì™„ë£Œ. ìºë¦­í„° ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.';
                 analyzeBtn.classList.add('btn-primary');
                 analyzeBtn.classList.remove('btn-danger');
            } else if (analyzedLines.length === 0 && currentText.length > 0) {
                 statusText.textContent = 'ëŒ€ê¸° ì¤‘. "ëŒ€ë³¸ ë¶„ì„" ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.';
            }
        }
    }


    function attachSingleSliderHandler(slider, valueSpan) {
        if (slider && valueSpan) {
            valueSpan.textContent = parseFloat(slider.value).toFixed(slider.step === '1' || slider.step === '50' ? 0 : 2); 
            slider.addEventListener('input', () => {
                valueSpan.textContent = parseFloat(slider.value).toFixed(slider.step === '1' || slider.step === '50' ? 0 : 2);
            });
        }
    }

    function updatePlayerControls() {
        if (synth.speaking && !synth.paused) {
            playBtn.innerHTML = 'â¸ ì¼ì‹œì •ì§€'; // Play ë²„íŠ¼ì´ Pause ê¸°ëŠ¥ ê²¸í•¨
            playBtn.classList.add('btn-warning');
            playBtn.classList.remove('btn-success', 'btn-secondary');
            
            pauseBtn.innerHTML = 'â¸ ì¼ì‹œì •ì§€'; 
            pauseBtn.classList.add('disabled');
            stopBtn.classList.remove('disabled');
            
        } else if (synth.paused) {
            playBtn.innerHTML = 'â–¶ ì´ì–´ì„œ ì¬ìƒ'; 
            playBtn.classList.add('btn-success');
            playBtn.classList.remove('btn-warning', 'btn-secondary');
            
            pauseBtn.innerHTML = 'ì¼ì‹œì •ì§€ë¨ <i class="bi bi-pause-fill"></i>';
            pauseBtn.classList.add('disabled');
            stopBtn.classList.remove('disabled');
            
        } else {
            playBtn.innerHTML = 'â–¶ ì¬ìƒ (ì²˜ìŒë¶€í„°)';
            playBtn.classList.add('btn-success');
            playBtn.classList.remove('btn-warning', 'btn-secondary');
            
            pauseBtn.innerHTML = 'â¸ ì¼ì‹œì •ì§€'; 
            pauseBtn.classList.add('disabled');
            stopBtn.classList.add('disabled');
        }
    }


    function loadVoices() {
        availableVoices = synth.getVoices() || [];
    }
    
    // íŒŒì¼ ë¡œë“œ ë¡œì§ (ë³€ê²½ ì—†ìŒ)
    function loadSettingsFromFile(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
            try {
                const settings = JSON.parse(ev.target.result);
                const scriptHtml = settings.script.split('\n').map(line => `<p>${escapeHtml(line)}</p>`).join('');
                scriptEditor.innerHTML = scriptHtml; 

                analyzeScript(() => {
                    Object.keys(settings.characters || {}).forEach(name => {
                        const charSet = settings.characters[name];
                        const voiceSel = document.getElementById(`voice-for-${name}`);
                        const pitchSel = document.getElementById(`pitch-for-${name}`);
                        const rateSel = document.getElementById(`rate-for-${name}`);
                        const volumeSel = document.getElementById(`volume-for-${name}`);
                        
                        if (voiceSel && charSet.voice) voiceSel.value = charSet.voice; 
                        if (pitchSel && charSet.pitch !== undefined) pitchSel.value = charSet.pitch;
                        if (rateSel && charSet.rate !== undefined) rateSel.value = charSet.rate;
                        if (volumeSel && charSet.volume !== undefined) volumeSel.value = charSet.volume;
                        
                        const pitchValueSpan = document.getElementById(`pitch-value-for-${name}`);
                        const rateValueSpan = document.getElementById(`rate-value-for-${name}`);
                        const volumeValueSpan = document.getElementById(`volume-value-for-${name}`);
                        if (pitchValueSpan) pitchValueSpan.textContent = parseFloat(pitchSel.value).toFixed(2);
                        if (rateValueSpan) rateValueSpan.textContent = parseFloat(rateSel.value).toFixed(2);
                        if (volumeValueSpan) volumeValueSpan.textContent = parseFloat(volumeSel.value).toFixed(2);
                    });
                    
                    if (settings.globalRate !== undefined) globalRateSlider.value = settings.globalRate; 
                    globalRateValueSpan.textContent = parseFloat(globalRateSlider.value).toFixed(2);
                    
                    if (settings.sentencePauseMs !== undefined) sentencePauseMsSlider.value = settings.sentencePauseMs; 
                    sentencePauseMsValueSpan.textContent = parseFloat(sentencePauseMsSlider.value).toFixed(0);
                    
                    checkScriptModification();
                });
                alert("ğŸ“‚ JSON íŒŒì¼ì—ì„œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.");
            } catch (err) {
                alert("âŒ JSON íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
        };
        reader.readAsText(file, "utf-8");
    }

    // íŒŒì¼ ì €ì¥ ë¡œì§ (ë³€ê²½ ì—†ìŒ)
    function exportSettingsToFile() {
        const settings = {
            script: scriptEditor.innerText, 
            globalRate: parseFloat(globalRateSlider.value), 
            sentencePauseMs: parseFloat(sentencePauseMsSlider.value),
            characters: {}
        };
        
        Array.from(document.querySelectorAll('.character-card')).forEach(card => {
            // Note: The structure needs adjustment if we rely on h6 strong to get the name, 
            // but in the single-card rendering, this is reliable.
            const name = card.querySelector('h6 strong').textContent;
            const voiceSel = document.getElementById(`voice-for-${name}`);
            const pitchSel = document.getElementById(`pitch-for-${name}`);
            const rateSel = document.getElementById(`rate-for-${name}`);
            const volumeSel = document.getElementById(`volume-for-${name}`);
            
            settings.characters[name] = {
                voice: voiceSel ? voiceSel.value : '',
                pitch: pitchSel ? parseFloat(pitchSel.value) : 1,
                rate: rateSel ? parseFloat(rateSel.value) : 1,
                volume: volumeSel ? parseFloat(volumeSel.value) : 1,
            };
        });

        const blob = new Blob([JSON.stringify(settings, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "narration-settings.json";
        a.click();
        URL.revokeObjectURL(url);
        alert("ğŸ’¾ JSON íŒŒì¼ë¡œ ë‚´ë³´ëƒˆìŠµë‹ˆë‹¤.");
    }


    function removeCurrentLineClass() {
        scriptEditor.querySelectorAll('.current-line').forEach(p => {
            p.classList.remove('current-line');
        });
    }

    function removeHighlight() {
        scriptEditor.querySelectorAll('.highlight').forEach(span => {
            const parent = span.parentNode;
            while (span.firstChild) {
                parent.insertBefore(span.firstChild, span);
            }
            parent.removeChild(span);
        });
        scriptEditor.normalize(); 
    }
    
    function scrollAndHighlightSentence(lineIndex) {
        removeHighlight();
        removeCurrentLineClass();
        
        const lineData = analyzedLines[lineIndex];
        if (!lineData) return;
        
        const lineElement = scriptEditor.querySelectorAll('p')[lineData.domIndex];

        if (lineElement) {
            lineElement.classList.add('current-line');
        }
    }

    function highlightWord(lineIndex, charIndex, charLength) {
        removeHighlight();
        
        const lineData = analyzedLines[lineIndex];
        if (!lineData) return;
        
        const lineElement = scriptEditor.querySelectorAll('p')[lineData.domIndex];

        if (!lineElement) return;

        let currentNode = lineElement.firstChild;
        let runningIndex = 0;
        
        while (currentNode) {
            if (currentNode.nodeType === Node.TEXT_NODE) {
                const nodeText = currentNode.textContent;
                const nodeLength = nodeText.length;
                
                if (runningIndex <= charIndex && runningIndex + nodeLength >= charIndex + charLength) {
                    const startInNode = charIndex - runningIndex;
                    const endInNode = startInNode + charLength;

                    if (startInNode < nodeLength && endInNode <= nodeLength) {
                        const range = document.createRange();
                        range.setStart(currentNode, startInNode);
                        range.setEnd(currentNode, endInNode);

                        const span = document.createElement('span');
                        span.className = 'highlight';
                        range.surroundContents(span);
                        
                        return;
                    }
                }
                runningIndex += nodeLength;
            }
            currentNode = currentNode.nextSibling;
        }
    }


    function analyzeScript(callback) {
        if (isScriptLocked) {
            scriptEditor.contentEditable = 'true';
            isScriptLocked = false;
        }

        const pElements = scriptEditor.querySelectorAll('p');
        
        if (pElements.length === 0) { 
            alert('ëŒ€ë³¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!'); 
            lastAnalyzedText = ''; 
            return; 
        }
        
        if (availableVoices.length === 0) {
            loadVoices(); 
        }

        synth.cancel(); 
        isStopping = true; 
        currentPlaybackIndex = 0; 
        setTimeout(() => isStopping = false, 100); 

        const characters = new Map();
        const characterColorMap = new Map();
        let colorIndex = 0;
        analyzedLines = [];
        let runningIndex = 0;

        pElements.forEach((pElement, domIndex) => {
            const line = pElement.innerText;
            const trimmedLine = line.trim();
            
            pElement.className = pElement.className.replace(/char-color-\d/g, '').trim(); 
            pElement.classList.remove('script-line');
            
            let charName = 'í•´ì„¤';
            let content = trimmedLine;
            let currentLineColorIndex = -1;

            if (trimmedLine) {
                const m = trimmedLine.match(/^([^:ï¼š]+)[ï¼š:]\s*(.*)/);
                
                if (m) {
                    charName = m[1].trim();
                    content = m[2].trim();
                }
                
                const clean = content.replace(/\([^)]*\)/g, '').trim();
                
                if (charName && !characters.has(charName)) {
                    characters.set(charName, { id: `char-${characters.size}`, firstText: clean }); 
                    
                    if (!characterColorMap.has(charName)) {
                        characterColorMap.set(charName, colorIndex % 3); 
                        colorIndex++;
                    }
                }
                
                if (characterColorMap.has(charName)) {
                    currentLineColorIndex = characterColorMap.get(charName);
                    pElement.classList.add(`char-color-${currentLineColorIndex}`);
                }
                
                pElement.classList.add('script-line');


                if (clean) analyzedLines.push({ 
                    character: charName, 
                    text: clean,
                    originalLine: line,
                    startIndex: runningIndex,
                    endIndex: runningIndex + line.length, 
                    domIndex: domIndex,
                    colorIndex: currentLineColorIndex
                });
            } else {
                 pElement.classList.add('script-line');
            }
            
            runningIndex += line.length + 1; 
        });

        if (analyzedLines.length === 0) {
            alert('ëŒ€ë³¸ì—ì„œ ìœ íš¨í•œ ë¬¸ì¥ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            characterSettingsDiv.style.display = 'none';
            playerDiv.style.display = 'none';
            statusText.textContent = 'ëŒ€ë³¸ ë¶„ì„ ì‹¤íŒ¨.';
            lastAnalyzedText = ''; 
            isStopping = false; 
            return;
        }
        
        Array.from(characters.keys()).forEach(name => {
             characters.get(name).colorIndex = characterColorMap.get(name);
        });
        
        lastAnalyzedText = scriptEditor.innerText.trim();

        // ë¶„ì„ ì„±ê³µ ì‹œ ëŒ€ë³¸ í¸ì§‘ ì ê¸ˆ ë° ë²„íŠ¼ í‘œì‹œ
        scriptEditor.contentEditable = 'false';
        isScriptLocked = true;
        editModeBtn.style.display = 'block';
        
        renderCharacterSettings(Array.from(characters.keys()), characters);
        characterSettingsDiv.style.display = 'block';
        playerDiv.style.display = 'block';
        statusText.textContent = 'ëŒ€ë³¸ ë¶„ì„ ì™„ë£Œ. í¸ì§‘ì´ ì ê¸ˆë˜ì—ˆìŠµë‹ˆë‹¤. ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.';
        
        if (callback) callback();
    }
    
    /**
     * @V23.1.9: ìºë¦­í„° ì¹´ë“œì—ì„œ ì²´í¬ë°•ìŠ¤ë¥¼ ì‚­ì œí•˜ê³  V23.1.7 ë²„ì „ìœ¼ë¡œ ë³µêµ¬
     */
    function renderCharacterSettings(characterNames, characterMap) {
        characterListDiv.innerHTML = '';
        const koreanVoices = availableVoices.filter(v => (v.lang || '').toLowerCase().startsWith('ko'));

        if (koreanVoices.length === 0) {
            voiceWarning.style.display = 'block';
        } else {
            voiceWarning.style.display = 'none';
        }

        const colorMap = ['#0d6efd', '#20c997', '#ffc107']; 

        characterNames.forEach(name => {
            const charData = characterMap.get(name);
            const selectId = `voice-for-${name}`;
            const pitchId = `pitch-for-${name}`;
            const rateId = `rate-for-${name}`;
            const volumeId = `volume-for-${name}`;
            const previewId = `preview-for-${name}`;
            
            const colorClass = `char-color-${charData.colorIndex}`;
            const cardColor = colorMap[charData.colorIndex];

            let options = '';
            if (koreanVoices.length > 0) {
                options = koreanVoices.map((v, index) => { 
                    const voiceIndex = availableVoices.indexOf(v);
                    const selectedAttr = (index === 0) ? 'selected' : ''; 
                    return `<option value="${voiceIndex}" ${selectedAttr}>${escapeHtml(v.name || 'unknown')} (${escapeHtml(v.lang || '')})</option>`;
                }).join('');
            } else {
                options = `<option value="">(í•œêµ­ì–´ ìŒì„±ì´ ì—†ìŠµë‹ˆë‹¤)</option>`;
            }

            const div = document.createElement('div');
            div.className = `card character-card p-3 ${colorClass}`; 
            div.innerHTML = `
                <h6 class="mb-2"><strong>${escapeHtml(name)}</strong> <span style="font-size: 10px; color: ${cardColor}">â—</span></h6>
                <div class="input-group mb-2">
                    <span class="input-group-text">ëª©ì†Œë¦¬</span>
                    <select id="${selectId}" class="form-select voice-select">${options}</select>
                </div>
                
                <button class="btn btn-outline-secondary mb-3 w-100" id="${previewId}">
                    <i class="bi bi-play-fill"></i> ì²« ë¬¸ì¥ ë¯¸ë¦¬ë“£ê¸°
                </button>

                <label class="slider-label">
                    ë†’ë‚®ì´ (Pitch) 
                    <span id="pitch-value-for-${name}" class="badge text-bg-secondary">1.00</span>
                </label>
                <input type="range" id="${pitchId}" min="0" max="2" step="0.01" value="1" class="form-range mb-2">
                
                <label class="slider-label">
                    ë³¼ë¥¨ (Volume)
                    <span id="volume-value-for-${name}" class="badge text-bg-secondary">1.00</span>
                </label>
                <input type="range" id="${volumeId}" min="0" max="1" step="0.01" value="1" class="form-range mb-2">
                
                <label class="slider-label">
                    ì†ë„ (Rate)
                    <span id="rate-value-for-${name}" class="badge text-bg-secondary">1.00</span>
                </label>
                <input type="range" id="${rateId}" min="0.1" max="4" step="0.01" value="1" class="form-range">
            `;
            characterListDiv.appendChild(div);

            document.getElementById(previewId).addEventListener('click', () => {
                playSingleUtterance(name, charData.firstText);
            });

            attachSingleSliderHandler(document.getElementById(pitchId), document.getElementById(`pitch-value-for-${name}`));
            attachSingleSliderHandler(document.getElementById(volumeId), document.getElementById(`volume-value-for-${name}`));
            attachSingleSliderHandler(document.getElementById(rateId), document.getElementById(`rate-value-for-${name}`));
        });
    }

    
    function playSingleUtterance(characterName, text) {
        isStopping = false; 
        const voiceSel = document.getElementById(`voice-for-${characterName}`);
        const pitchSel = document.getElementById(`pitch-for-${characterName}`);
        const rateSel = document.getElementById(`rate-for-${characterName}`);
        const volumeSel = document.getElementById(`volume-for-${characterName}`);
        const globalRate = parseFloat(globalRateSlider.value);

        if (!voiceSel || voiceSel.value === "") {
            alert('ì„ íƒ ê°€ëŠ¥í•œ í•œêµ­ì–´ ëª©ì†Œë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        const u = new SpeechSynthesisUtterance(text);
        const idx = parseInt(voiceSel.value);
        if (!isNaN(idx) && availableVoices[idx]) u.voice = availableVoices[idx];

        u.pitch = pitchSel ? parseFloat(pitchSel.value) : 1;
        u.rate = (rateSel ? parseFloat(rateSel.value) : 1) * globalRate;
        u.volume = volumeSel ? parseFloat(volumeSel.value) : 1;

        synth.cancel();
        removeHighlight();
        removeCurrentLineClass();
        
        u.onend = () => {
            isStopping = false;
            statusText.textContent = `[${characterName}] ë¯¸ë¦¬ë“£ê¸° ì™„ë£Œ`; 
            updatePlayerControls();
        };

        synth.speak(u);
        statusText.textContent = `[${characterName}] ë¯¸ë¦¬ë“£ê¸°: ${text.substring(0, 30)}...`;
        updatePlayerControls();
    }

    /**
     * @V23.1.7: ë¬¸ì¥ ê°„ ì§€ì—° ì‹œê°„ ê¸°ë³¸ê°’ 100ms -> 0msë¡œ ë‹¨ì¶•
     * V23.1.9ì—ì„œë„ ì´ ë¡œì§ì€ ìœ ì§€ë¨.
     */
    function playNarration() {
        if (scriptEditor.innerText.trim() !== lastAnalyzedText.trim()) {
            statusText.innerHTML = 'âŒ ì¬ìƒ ì‹¤íŒ¨: ëŒ€ë³¸ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤. **"ëŒ€ë³¸ ë¶„ì„"**ì„ ë¨¼ì € ëˆŒëŸ¬ì£¼ì„¸ìš”.';
            return;
        }
        
        if (analyzedLines.length === 0) {
            analyzeScript(() => playNarration()); 
            return;
        }

        // 1. ì¬ìƒ ì¢…ë£Œ ì¡°ê±´
        if (currentPlaybackIndex >= analyzedLines.length) {
            removeCurrentLineClass();
            statusText.textContent = 'âœ… ì¬ìƒ ì™„ë£Œ'; 
            updatePlayerControls();
            checkScriptModification(); 
            currentPlaybackIndex = 0; 
            return;
        }
        
        // 2. ì¼ì‹œì •ì§€ ìƒíƒœ ì²´í¬ (ì¬ìƒì„ ì¬ê°œí•˜ëŠ” ê²ƒì€ Play ë²„íŠ¼ì—ì„œ ì²˜ë¦¬)
        if (synth.paused) {
            return;
        }
        
        // 3. ì¤‘ë‹¨ ìƒíƒœ ì²´í¬ (ì´ ì‹œì ì—ì„œ isStoppingì€ falseì—¬ì•¼ í•¨)
        if (isStopping) {
            return; 
        }

        // 4. ìƒˆë¡œìš´ ë¬¸ì¥ ì¬ìƒ
        const lineIndex = currentPlaybackIndex; 
        const line = analyzedLines[lineIndex];
        const u = new SpeechSynthesisUtterance(line.text);
        const voiceSel = document.getElementById(`voice-for-${line.character}`);
        const pitchSel = document.getElementById(`pitch-for-${line.character}`);
        const rateSel = document.getElementById(`rate-for-${line.character}`);
        const volumeSel = document.getElementById(`volume-for-${line.character}`);
        const globalRate = parseFloat(globalRateSlider.value);

        // ëª©ì†Œë¦¬ ë° ì„¤ì • ì ìš©
        if (voiceSel && voiceSel.value !== "") {
            const idxVoice = parseInt(voiceSel.value);
            if (!isNaN(idxVoice) && availableVoices[idxVoice]) u.voice = availableVoices[idxVoice];
        }
        if (pitchSel) u.pitch = parseFloat(pitchSel.value);
        if (rateSel) u.rate = parseFloat(rateSel.value) * globalRate; 
        if (volumeSel) u.volume = parseFloat(volumeSel.value);
        
        u.lineIndex = lineIndex; 

        // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        u.onstart = () => { 
            statusText.textContent = `[${line.character}] ${line.text.substring(0, 30)}...`; 
            scrollAndHighlightSentence(lineIndex); 
            updatePlayerControls();
        };
        
        u.onboundary = (event) => {
            if (event.name === 'word') {
                highlightWord(lineIndex, event.charIndex, event.charLength); 
            }
        };

        u.onend = () => {
            removeHighlight();
            
            currentPlaybackIndex++; 
            
            if (isStopping) return; 

            const defaultPause = parseFloat(sentencePauseMsSlider.value);

            if (currentPlaybackIndex < analyzedLines.length) {
                // ë¬¸ì¥ ê°„ ì§€ì—° ì‹œê°„ í›„ ë‹¤ìŒ ë¬¸ì¥ ì¬ìƒ í˜¸ì¶œ
                if (defaultPause > 0) {
                    statusText.textContent = `â¸ ${defaultPause}ms ì§€ì—° í›„ ë‹¤ìŒ ë¬¸ì¥ ì¬ìƒ...`;
                } else {
                    // 0msì¼ ê²½ìš° ì§€ì—° ë©”ì‹œì§€ ì—†ì´ ë°”ë¡œ ë‹¤ìŒ ë¬¸ì¥ í˜¸ì¶œ
                    statusText.textContent = `â–¶ ë‹¤ìŒ ë¬¸ì¥ ì¦‰ì‹œ ì¬ìƒ...`; 
                }
                
                setTimeout(() => {
                    // setTimeoutì´ ì‹¤í–‰ë  ë•Œë„ ë‹¤ì‹œ í•œë²ˆ ì •ì§€ ìƒíƒœ ì²´í¬
                    if (!synth.paused && !isStopping) { 
                        playNarration(); 
                    }
                }, defaultPause);
            } else {
                // ëª¨ë“  ë¬¸ì¥ ì¬ìƒ ì™„ë£Œ í›„ ì¢…ë£Œ ì²˜ë¦¬ ë¡œì§
                removeCurrentLineClass();
                statusText.textContent = 'âœ… ì¬ìƒ ì™„ë£Œ'; 
                updatePlayerControls();
                checkScriptModification(); 
                currentPlaybackIndex = 0;
            }
        };
        
        u.onerror = (event) => {
            console.error('Speech Synthesis Error:', event);
            statusText.textContent = `âŒ ìŒì„± í•©ì„± ì˜¤ë¥˜: ${event.error}. ë‹¤ìŒ ë¬¸ì¥ìœ¼ë¡œ ê±´ë„ˆëœë‹ˆë‹¤.`;
            if (!isStopping) { 
                currentPlaybackIndex++; 
                playNarration(); 
            }
        }

        // ì¬ìƒ ì‹œì‘
        synth.speak(u);
        updatePlayerControls();
    }


    // --- Helper ---
    function escapeHtml(str) {
        return String(str)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    initialize();
</script>
</body>
</html>